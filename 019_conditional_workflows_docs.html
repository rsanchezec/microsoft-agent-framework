<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentaci√≥n: Workflows Condicionales - Microsoft Agent Framework</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        h2 {
            color: #ff5858;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 3px solid #ff5858;
            padding-bottom: 10px;
        }

        h3 {
            color: #f857a6;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        h4 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .diagram-container {
            background: #fff0f5;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #ff5858;
        }

        .diagram-title {
            text-align: center;
            font-weight: bold;
            color: #ff5858;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .flow-box {
            background: white;
            border: 3px solid #ff5858;
            border-radius: 8px;
            padding: 20px 30px;
            min-width: 180px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .flow-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .flow-box.decision {
            background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
            color: white;
            font-weight: bold;
            border-radius: 50%;
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .flow-box.handler {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .flow-box.validator {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            font-weight: bold;
        }

        .arrow {
            font-size: 2em;
            color: #ff5858;
            font-weight: bold;
        }

        .arrow-down {
            font-size: 2em;
            color: #ff5858;
            font-weight: bold;
            display: block;
            text-align: center;
            margin: 10px 0;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border-left: 4px solid #ff5858;
        }

        .code-block code {
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.5;
            white-space: pre-wrap;
            display: block;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #856404;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .component-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .component-card:hover {
            border-color: #ff5858;
            box-shadow: 0 4px 16px rgba(255, 88, 88, 0.3);
        }

        .component-card h4 {
            color: #ff5858;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #ff5858;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #fff0f5;
        }

        .toc {
            background: #fff0f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .toc h3 {
            color: #ff5858;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            margin-left: 0;
        }

        .toc li {
            margin-bottom: 10px;
        }

        .toc a {
            color: #ff5858;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .toc a:hover {
            color: #f857a6;
            text-decoration: underline;
        }

        .footer {
            background: #2d2d2d;
            color: white;
            padding: 30px;
            text-align: center;
        }

        ul, ol {
            margin-left: 30px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
        }

        .pattern-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .flow-box.decision {
                width: 120px;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîÄ Workflows Condicionales - Microsoft Agent Framework</h1>
            <p>Documentaci√≥n Completa del Script 019_conditional_workflows.py</p>
        </header>

        <div class="content">
            <!-- Tabla de Contenidos -->
            <div class="toc">
                <h3>üìë Tabla de Contenidos</h3>
                <ul>
                    <li><a href="#introduccion">1. Introducci√≥n</a></li>
                    <li><a href="#conceptos">2. ¬øQu√© son Workflows Condicionales?</a></li>
                    <li><a href="#patrones">3. Tres Patrones Principales</a></li>
                    <li><a href="#clasificador">4. Patr√≥n 1: Clasificador + Routing</a></li>
                    <li><a href="#validador">5. Patr√≥n 2: Validador + Retry Logic</a></li>
                    <li><a href="#complejidad">6. Patr√≥n 3: Routing por Complejidad</a></li>
                    <li><a href="#implementacion">7. Implementaci√≥n con send_message_to()</a></li>
                    <li><a href="#mejores-practicas">8. Mejores Pr√°cticas</a></li>
                </ul>
            </div>

            <!-- 1. Introducci√≥n -->
            <h2 id="introduccion">1. üìñ Introducci√≥n</h2>
            <p>
                El script <span class="highlight">019_conditional_workflows.py</span> demuestra c√≥mo crear
                <strong>Workflows Condicionales</strong> con el <strong>Microsoft Agent Framework</strong>.
                A diferencia de workflows secuenciales (A‚ÜíB‚ÜíC) o paralelos (A‚Üí[B,C,D]‚ÜíE), los workflows condicionales
                permiten que el <strong>flujo de ejecuci√≥n cambie din√°micamente</strong> bas√°ndose en condiciones,
                resultados previos, o decisiones del agente.
            </p>

            <div class="success-box">
                <strong>üéØ Concepto Clave:</strong> Los workflows condicionales introducen <strong>l√≥gica de decisi√≥n</strong>
                (if/else, switch, loops) en el flujo, permitiendo comportamiento adaptativo e inteligente.
            </div>

            <div class="info-box">
                <strong>üí° Analog√≠a del Mundo Real:</strong>
                <p>Imagina un sistema de atenci√≥n m√©dica:</p>
                <ul>
                    <li>üè• <strong>Triage:</strong> Clasifica al paciente (urgente, moderado, leve)</li>
                    <li>üîÄ <strong>Routing:</strong> Basado en la clasificaci√≥n, lo env√≠a a:
                        <ul>
                            <li>‚Üí Emergencias (si urgente)</li>
                            <li>‚Üí Consulta general (si moderado)</li>
                            <li>‚Üí Enfermer√≠a (si leve)</li>
                        </ul>
                    </li>
                    <li>üîÑ <strong>Retry:</strong> Si el diagn√≥stico es incierto, pide segunda opini√≥n</li>
                </ul>
                <p>Este es un workflow condicional en acci√≥n.</p>
            </div>

            <!-- Diagrama Principal -->
            <div class="diagram-container">
                <div class="diagram-title">üîÄ Flujo Condicional vs Secuencial</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Secuencial -->
                    <div>
                        <h4 style="text-align: center; color: #667eea; margin-bottom: 15px;">Secuencial (Lineal)</h4>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <div style="background: #667eea; color: white; padding: 15px; border-radius: 8px; width: 80%;">A</div>
                            <span style="font-size: 1.5em; color: #667eea;">‚Üì</span>
                            <div style="background: #667eea; color: white; padding: 15px; border-radius: 8px; width: 80%;">B</div>
                            <span style="font-size: 1.5em; color: #667eea;">‚Üì</span>
                            <div style="background: #667eea; color: white; padding: 15px; border-radius: 8px; width: 80%;">C</div>
                        </div>
                        <p style="text-align: center; margin-top: 10px; font-size: 0.9em;">Siempre el mismo camino</p>
                    </div>

                    <!-- Condicional -->
                    <div>
                        <h4 style="text-align: center; color: #ff5858; margin-bottom: 15px;">Condicional (Adaptativo)</h4>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                            <div style="background: #ff5858; color: white; padding: 15px; border-radius: 8px; width: 80%;">A</div>
                            <span style="font-size: 1.5em; color: #ff5858;">‚Üì</span>
                            <div style="background: #f857a6; color: white; padding: 15px; border-radius: 50%; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; font-weight: bold;">IF/ELSE</div>
                            <div style="display: flex; gap: 10px; width: 100%;">
                                <div style="background: #28a745; color: white; padding: 10px; border-radius: 8px; flex: 1; text-align: center;">‚Üí B</div>
                                <div style="background: #ffc107; color: white; padding: 10px; border-radius: 8px; flex: 1; text-align: center;">‚Üí C</div>
                                <div style="background: #2196F3; color: white; padding: 10px; border-radius: 8px; flex: 1; text-align: center;">‚Üí D</div>
                            </div>
                        </div>
                        <p style="text-align: center; margin-top: 10px; font-size: 0.9em;">Camino depende de condiciones</p>
                    </div>
                </div>
            </div>

            <!-- 2. Conceptos -->
            <h2 id="conceptos">2. üß† ¬øQu√© son Workflows Condicionales?</h2>

            <p>
                Los <strong>Workflows Condicionales</strong> son flujos de trabajo donde la ruta de ejecuci√≥n
                se determina <strong>din√°micamente en runtime</strong> bas√°ndose en:
            </p>

            <div class="component-grid">
                <div class="component-card">
                    <h4>üéØ Condiciones Est√°ticas</h4>
                    <p>Decisiones basadas en reglas predefinidas</p>
                    <ul>
                        <li>If/else hardcodeado</li>
                        <li>Switch case</li>
                        <li>Thresholds num√©ricos</li>
                    </ul>
                    <p><strong>Ejemplo:</strong> Si error_count > 3, usar fallback</p>
                </div>

                <div class="component-card">
                    <h4>ü§ñ Decisiones del Agente</h4>
                    <p>El agente analiza y decide la ruta</p>
                    <ul>
                        <li>Clasificaci√≥n de consultas</li>
                        <li>Scoring de complejidad</li>
                        <li>An√°lisis de sentimiento</li>
                    </ul>
                    <p><strong>Ejemplo:</strong> Agente clasifica query como "t√©cnico" o "general"</p>
                </div>

                <div class="component-card">
                    <h4>üìä Resultados Previos</h4>
                    <p>Decisiones basadas en outputs anteriores</p>
                    <ul>
                        <li>Validaci√≥n de calidad</li>
                        <li>Retry logic</li>
                        <li>Error handling</li>
                    </ul>
                    <p><strong>Ejemplo:</strong> Si validaci√≥n falla, reintentar hasta 3 veces</p>
                </div>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Diferencia Clave:</strong>
                <ul>
                    <li><strong>Workflows Secuenciales:</strong> A ‚Üí B ‚Üí C (siempre el mismo camino)</li>
                    <li><strong>Workflows Paralelos:</strong> A ‚Üí [B,C,D] ‚Üí E (caminos paralelos fijos)</li>
                    <li><strong>Workflows Condicionales:</strong> A ‚Üí (if X: B, elif Y: C, else: D) (camino din√°mico)</li>
                </ul>
            </div>

            <!-- 3. Patrones -->
            <h2 id="patrones">3. üéØ Tres Patrones Principales</h2>

            <p>El script demuestra <strong>3 patrones fundamentales</strong> de workflows condicionales:</p>

            <div class="pattern-comparison">
                <div class="component-card">
                    <h4>1Ô∏è‚É£ Clasificador + Routing</h4>
                    <p><strong>Patr√≥n:</strong> If/Else b√°sico</p>
                    <p><strong>Flujo:</strong></p>
                    <div style="text-align: center; margin: 10px 0; font-family: monospace; font-size: 0.9em;">
                        Query ‚Üí Classifier<br>
                        ‚Üì<br>
                        if "technical": ‚Üí Tech Handler<br>
                        elif "creative": ‚Üí Creative Handler<br>
                        else: ‚Üí General Handler
                    </div>
                    <p><strong>Uso:</strong> Routing de consultas por categor√≠a</p>
                </div>

                <div class="component-card">
                    <h4>2Ô∏è‚É£ Validador + Retry Logic</h4>
                    <p><strong>Patr√≥n:</strong> Loop con validaci√≥n</p>
                    <p><strong>Flujo:</strong></p>
                    <div style="text-align: center; margin: 10px 0; font-family: monospace; font-size: 0.9em;">
                        Generator ‚Üí Validator<br>
                        ‚Üì<br>
                        if valid: ‚Üí Output<br>
                        elif attempt < 3: ‚Üí Improver ‚Üí Validator (loop)<br>
                        else: ‚Üí Output (failed)
                    </div>
                    <p><strong>Uso:</strong> Validaci√≥n de calidad con retry</p>
                </div>

                <div class="component-card">
                    <h4>3Ô∏è‚É£ Routing por Complejidad</h4>
                    <p><strong>Patr√≥n:</strong> Escalamiento adaptativo</p>
                    <p><strong>Flujo:</strong></p>
                    <div style="text-align: center; margin: 10px 0; font-family: monospace; font-size: 0.9em;">
                        Query ‚Üí Router (scoring)<br>
                        ‚Üì<br>
                        if complexity ‚â§ 3: ‚Üí Simple Agent<br>
                        elif complexity ‚â§ 7: ‚Üí Standard Agent<br>
                        else: ‚Üí Expert Agent
                    </div>
                    <p><strong>Uso:</strong> Optimizar recursos por complejidad</p>
                </div>
            </div>

            <!-- 4. Patr√≥n 1: Clasificador -->
            <h2 id="clasificador">4. üéØ Patr√≥n 1: Clasificador + Routing (If/Else)</h2>

            <div class="diagram-container">
                <div class="diagram-title">üìã Flujo del Clasificador</div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <div class="flow-box">
                        <strong>üë§ Usuario</strong><br>
                        <small>"Explica qu√© es una funci√≥n lambda en Python"</small>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div class="flow-box decision">
                        <strong>üîç</strong><br>
                        <strong>CLASSIFIER</strong><br>
                        <small>Analiza categor√≠a</small>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                        <div>
                            <div style="text-align: center; margin-bottom: 10px; color: #28a745; font-weight: bold;">
                                if "technical"
                            </div>
                            <div class="flow-box handler" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <strong>üíª Technical</strong><br>
                                <small>Handler</small>
                            </div>
                        </div>

                        <div>
                            <div style="text-align: center; margin-bottom: 10px; color: #f857a6; font-weight: bold;">
                                elif "creative"
                            </div>
                            <div class="flow-box handler" style="background: linear-gradient(135deg, #f857a6 0%, #ff6b9d 100%);">
                                <strong>üé® Creative</strong><br>
                                <small>Handler</small>
                            </div>
                        </div>

                        <div>
                            <div style="text-align: center; margin-bottom: 10px; color: #2196F3; font-weight: bold;">
                                else
                            </div>
                            <div class="flow-box handler" style="background: linear-gradient(135deg, #2196F3 0%, #21cbf3 100%);">
                                <strong>üìö General</strong><br>
                                <small>Handler</small>
                            </div>
                        </div>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div class="flow-box" style="background: #d4edda;">
                        <strong>üì§ Output</strong><br>
                        <small>Respuesta especializada</small>
                    </div>
                </div>
            </div>

            <h3>4.1. Implementaci√≥n del Clasificador</h3>

            <div class="code-block"><code>def create_classifier_executor(classifier_agent):
    &quot;&quot;&quot;Executor que clasifica y decide la ruta&quot;&quot;&quot;
    @executor(id=&quot;Classifier&quot;)
    async def classifier(query: str, ctx: WorkflowContext[str]) -&gt; None:
        print(f&quot;[CLASSIFIER] üîç Clasificando: {query}&quot;)

        # El agente clasifica la consulta
        classification_prompt = f&quot;&quot;&quot;
Clasifica en UNA de estas categor√≠as:
- &quot;technical&quot; - Pregunta t√©cnica
- &quot;general&quot; - Pregunta general
- &quot;creative&quot; - Solicitud creativa

Consulta: {query}
Responde SOLO con: technical, general, o creative
&quot;&quot;&quot;
        response = await classifier_agent.run(classification_prompt)
        category = str(response).strip().lower()

        print(f&quot;[CLASSIFIER] ‚úÖ Categor√≠a: {category}&quot;)

        # ROUTING CONDICIONAL
        if &quot;technical&quot; in category or &quot;tech&quot; in category:
            print(f&quot;[CLASSIFIER] ‚Üí Ruta: Technical Handler&quot;)
            await ctx.send_message_to(&quot;TechnicalHandler&quot;, query)
        elif &quot;creative&quot; in category:
            print(f&quot;[CLASSIFIER] ‚Üí Ruta: Creative Handler&quot;)
            await ctx.send_message_to(&quot;CreativeHandler&quot;, query)
        else:
            print(f&quot;[CLASSIFIER] ‚Üí Ruta: General Handler&quot;)
            await ctx.send_message_to(&quot;GeneralHandler&quot;, query)

    return classifier
</code></div>

            <div class="info-box">
                <strong>üí° Clave del Patr√≥n:</strong>
                <ul>
                    <li>üîç <span class="highlight">send_message_to(executor_id, data)</span> permite routing din√°mico</li>
                    <li>üéØ El agente analiza el contenido y toma la decisi√≥n</li>
                    <li>üîÄ Diferentes executors manejan diferentes categor√≠as</li>
                    <li>‚úÖ Especializaci√≥n: cada handler es experto en su dominio</li>
                </ul>
            </div>

            <!-- 5. Patr√≥n 2: Validador -->
            <h2 id="validador">5. üîÑ Patr√≥n 2: Validador + Retry Logic (Loop)</h2>

            <div class="diagram-container">
                <div class="diagram-title">üîÑ Flujo con Validaci√≥n y Retry</div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <div class="flow-box">
                        <strong>üìù Generator</strong><br>
                        <small>Genera contenido</small>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div class="flow-box validator">
                        <strong>üîç Validator</strong><br>
                        <small>Valida calidad</small>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div class="flow-box decision">
                        <strong>‚ùì</strong><br>
                        <strong>¬øV√ÅLIDO?</strong>
                    </div>

                    <div style="display: flex; gap: 40px; width: 100%; justify-content: center; margin-top: 20px;">
                        <!-- Ruta SI -->
                        <div style="text-align: center;">
                            <div style="color: #28a745; font-weight: bold; margin-bottom: 10px;">‚úÖ S√ç</div>
                            <span class="arrow-down" style="color: #28a745;">‚Üì</span>
                            <div class="flow-box" style="background: #d4edda; border-color: #28a745;">
                                <strong>üì§ Output</strong><br>
                                <small>Contenido v√°lido</small>
                            </div>
                        </div>

                        <!-- Ruta NO -->
                        <div style="text-align: center;">
                            <div style="color: #dc3545; font-weight: bold; margin-bottom: 10px;">‚ùå NO</div>
                            <span class="arrow-down" style="color: #dc3545;">‚Üì</span>
                            <div class="flow-box decision" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); width: 120px; height: 120px;">
                                <strong>üî¢</strong><br>
                                <strong>Intento < 3?</strong>
                            </div>
                            <div style="display: flex; gap: 20px; margin-top: 20px;">
                                <div>
                                    <div style="color: #28a745; font-weight: bold; margin-bottom: 5px; font-size: 0.9em;">S√ç</div>
                                    <span style="font-size: 1.5em; color: #28a745;">‚Üì</span>
                                    <div class="flow-box" style="background: #667eea; color: white; padding: 10px;">
                                        <strong>üîß Improver</strong>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 2em; color: #667eea;">‚Üª</div>
                                    <div style="font-size: 0.8em; color: #667eea;">Loop ‚Üí Validator</div>
                                </div>
                                <div>
                                    <div style="color: #dc3545; font-weight: bold; margin-bottom: 5px; font-size: 0.9em;">NO</div>
                                    <span style="font-size: 1.5em; color: #dc3545;">‚Üì</span>
                                    <div class="flow-box" style="background: #dc3545; color: white; padding: 10px;">
                                        <strong>‚ö†Ô∏è Failed</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3>5.1. Implementaci√≥n del Validador con Retry</h3>

            <div class="code-block"><code>def create_validator_executor(validator_agent):
    &quot;&quot;&quot;Executor que valida y decide si retry o terminar&quot;&quot;&quot;
    @executor(id=&quot;Validator&quot;)
    async def validator(data: dict, ctx: WorkflowContext[dict]) -&gt; None:
        content = data[&quot;content&quot;]
        query = data[&quot;query&quot;]
        attempt = data.get(&quot;attempt&quot;, 1)

        print(f&quot;[VALIDATOR] üîç Validando (Intento #{attempt})...&quot;)

        # Validaci√≥n (ejemplo simple: longitud m√≠nima)
        is_valid = len(content) &gt; 50

        if is_valid:
            # ‚úÖ V√ÅLIDO: Terminar con √©xito
            print(f&quot;[VALIDATOR] ‚úÖ Contenido v√°lido!&quot;)
            await ctx.send_message_to(&quot;Finalizer&quot;, content)
        else:
            # ‚ùå INV√ÅLIDO: Decidir retry o fallar
            print(f&quot;[VALIDATOR] ‚ùå Contenido inv√°lido (muy corto)&quot;)

            if attempt &lt; 3:
                # üîÑ RETRY: Enviar a mejorar
                print(f&quot;[VALIDATOR] üîÑ Reintentando (Intento {attempt + 1}/3)&quot;)
                await ctx.send_message_to(&quot;Improver&quot;, {
                    &quot;content&quot;: content,
                    &quot;query&quot;: query,
                    &quot;attempt&quot;: attempt + 1
                })
            else:
                # ‚ö†Ô∏è MAX INTENTOS: Fallar
                print(f&quot;[VALIDATOR] ‚ö†Ô∏è M√°ximo de intentos alcanzado&quot;)
                await ctx.send_message_to(&quot;Finalizer&quot;, f&quot;[FAILED] {content}&quot;)

    return validator
</code></div>

            <div class="success-box">
                <strong>‚úÖ Ventajas del Retry Logic:</strong>
                <ul>
                    <li>üîÑ <strong>Auto-correcci√≥n:</strong> Intenta mejorar resultados sub√≥ptimos</li>
                    <li>üéØ <strong>Calidad garantizada:</strong> No acepta contenido de baja calidad</li>
                    <li>‚ö†Ô∏è <strong>Fail-safe:</strong> Evita loops infinitos con l√≠mite de intentos</li>
                    <li>üìä <strong>M√©tricas:</strong> Trackear cu√°ntos retries se necesitan</li>
                </ul>
            </div>

            <!-- 6. Patr√≥n 3: Complejidad -->
            <h2 id="complejidad">6. üéì Patr√≥n 3: Routing por Complejidad (Escalamiento)</h2>

            <div class="diagram-container">
                <div class="diagram-title">üìä Routing basado en Scoring de Complejidad</div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <div class="flow-box">
                        <strong>üë§ Usuario Query</strong>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div class="flow-box decision">
                        <strong>üìä</strong><br>
                        <strong>COMPLEXITY</strong><br>
                        <strong>ROUTER</strong><br>
                        <small>Score 1-10</small>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="background: #28a745; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>Score 1-3</strong><br>
                                <small>Simple</small>
                            </div>
                            <span class="arrow-down" style="color: #28a745;">‚Üì</span>
                            <div class="flow-box handler" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <strong>‚ö° Simple</strong><br>
                                <strong>Agent</strong><br>
                                <small>Respuestas r√°pidas</small>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <div style="background: #ffc107; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>Score 4-7</strong><br>
                                <small>Moderado</small>
                            </div>
                            <span class="arrow-down" style="color: #ffc107;">‚Üì</span>
                            <div class="flow-box handler" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                                <strong>üìñ Standard</strong><br>
                                <strong>Agent</strong><br>
                                <small>Respuestas detalladas</small>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <div style="background: #dc3545; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>Score 8-10</strong><br>
                                <small>Complejo</small>
                            </div>
                            <span class="arrow-down" style="color: #dc3545;">‚Üì</span>
                            <div class="flow-box handler" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                <strong>üéì Expert</strong><br>
                                <strong>Agent</strong><br>
                                <small>An√°lisis profundo</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3>6.1. Implementaci√≥n del Router por Complejidad</h3>

            <div class="code-block"><code>def create_complexity_router_executor(router_agent):
    &quot;&quot;&quot;Router que eval√∫a complejidad y escala apropiadamente&quot;&quot;&quot;
    @executor(id=&quot;ComplexityRouter&quot;)
    async def complexity_router(query: str, ctx: WorkflowContext[str]) -&gt; None:
        print(f&quot;[COMPLEXITY ROUTER] üéØ Evaluando complejidad...&quot;)

        # Evaluar complejidad con el agente
        complexity_prompt = f&quot;&quot;&quot;
Eval√∫a la complejidad de esta consulta en una escala de 1-10:
1-3: Simple (hechos b√°sicos, preguntas directas)
4-7: Media (requiere an√°lisis o explicaci√≥n)
8-10: Alta (requiere razonamiento profundo)

Consulta: {query}

Responde SOLO con un n√∫mero del 1 al 10.
&quot;&quot;&quot;
        response = await router_agent.run(complexity_prompt)

        # Extraer n√∫mero
        try:
            complexity = int(''.join(filter(str.isdigit, str(response)))[:2])
        except:
            complexity = 5  # Default moderado

        print(f&quot;[COMPLEXITY ROUTER] üìä Complejidad: {complexity}/10&quot;)

        # ROUTING BASADO EN SCORE
        if complexity &lt;= 3:
            print(f&quot;[COMPLEXITY ROUTER] ‚Üí Simple Agent (r√°pido)&quot;)
            await ctx.send_message_to(&quot;SimpleAgent&quot;, query)
        elif complexity &lt;= 7:
            print(f&quot;[COMPLEXITY ROUTER] ‚Üí Standard Agent&quot;)
            await ctx.send_message_to(&quot;StandardAgent&quot;, query)
        else:
            print(f&quot;[COMPLEXITY ROUTER] ‚Üí Expert Agent (profundo)&quot;)
            await ctx.send_message_to(&quot;ExpertAgent&quot;, query)

    return complexity_router
</code></div>

            <div class="info-box">
                <strong>üí° Beneficios del Routing por Complejidad:</strong>
                <ul>
                    <li>‚ö° <strong>Optimizaci√≥n de recursos:</strong> Queries simples ‚Üí agente r√°pido/barato</li>
                    <li>üéØ <strong>Calidad apropiada:</strong> Queries complejas ‚Üí agente experto/caro</li>
                    <li>üí∞ <strong>Control de costos:</strong> No usar modelo grande para preguntas triviales</li>
                    <li>‚è±Ô∏è <strong>Latencia optimizada:</strong> Respuestas r√°pidas donde sea posible</li>
                </ul>
            </div>

            <!-- 7. Implementaci√≥n -->
            <h2 id="implementacion">7. üöÄ Implementaci√≥n con send_message_to()</h2>

            <p>
                La clave de los workflows condicionales es el m√©todo <span class="highlight">send_message_to()</span>
                del contexto del workflow, que permite <strong>routing din√°mico</strong> a ejecutores espec√≠ficos.
            </p>

            <div class="code-block"><code># Dentro de un executor
async def my_executor(data: str, ctx: WorkflowContext[str]) -&gt; None:
    # Analizar y tomar decisi√≥n
    if condition_A:
        # Enviar a ExecutorA
        await ctx.send_message_to(&quot;ExecutorA&quot;, data)
    elif condition_B:
        # Enviar a ExecutorB
        await ctx.send_message_to(&quot;ExecutorB&quot;, data)
    else:
        # Producir output final
        await ctx.yield_output(data)
</code></div>

            <h3>7.1. M√©todos del Workflow Context</h3>

            <table>
                <thead>
                    <tr>
                        <th>M√©todo</th>
                        <th>Prop√≥sito</th>
                        <th>Uso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="highlight">send_message_to(id, data)</span></td>
                        <td>Enviar a executor espec√≠fico</td>
                        <td>Routing condicional</td>
                    </tr>
                    <tr>
                        <td><span class="highlight">send_message(data)</span></td>
                        <td>Enviar al siguiente executor</td>
                        <td>Workflows secuenciales</td>
                    </tr>
                    <tr>
                        <td><span class="highlight">yield_output(data)</span></td>
                        <td>Producir output final</td>
                        <td>Terminar workflow</td>
                    </tr>
                </tbody>
            </table>

            <h3>7.2. Construcci√≥n del Workflow</h3>

            <div class="code-block"><code># Crear executors
classifier_exec = create_classifier_executor(classifier_agent)
technical_exec = create_technical_handler_executor(technical_agent)
creative_exec = create_creative_handler_executor(creative_agent)
general_exec = create_general_handler_executor(general_agent)

# Construir workflow
workflow = (
    WorkflowBuilder()
    .set_start_executor(classifier_exec)
    # Agregar TODAS las rutas posibles
    .add_edge(classifier_exec, technical_exec)
    .add_edge(classifier_exec, creative_exec)
    .add_edge(classifier_exec, general_exec)
    .build()
)

# El routing real se decide en runtime dentro del executor
</code></div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Importante:</strong>
                <ul>
                    <li>Debes agregar <span class="highlight">.add_edge()</span> para TODAS las rutas posibles</li>
                    <li>Esto define la <strong>topolog√≠a</strong> del workflow (qu√© conexiones existen)</li>
                    <li>El <strong>routing real</strong> se decide en runtime con <span class="highlight">send_message_to()</span></li>
                    <li>El framework valida que el executor_id destino exista</li>
                </ul>
            </div>

            <!-- 8. Mejores Pr√°cticas -->
            <h2 id="mejores-practicas">8. ‚ú® Mejores Pr√°cticas</h2>

            <h3>8.1. Cu√°ndo Usar Cada Patr√≥n</h3>

            <table>
                <thead>
                    <tr>
                        <th>Patr√≥n</th>
                        <th>Cu√°ndo Usar</th>
                        <th>Casos de Uso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Clasificador + Routing</strong></td>
                        <td>Cuando tienes categor√≠as distintas</td>
                        <td>
                            ‚Ä¢ Routing de tickets de soporte<br>
                            ‚Ä¢ Clasificaci√≥n de consultas<br>
                            ‚Ä¢ Content moderation
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Validador + Retry</strong></td>
                        <td>Cuando necesitas garantizar calidad</td>
                        <td>
                            ‚Ä¢ Generaci√≥n de c√≥digo<br>
                            ‚Ä¢ Escritura creativa<br>
                            ‚Ä¢ Data validation
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Routing por Complejidad</strong></td>
                        <td>Cuando quieres optimizar recursos</td>
                        <td>
                            ‚Ä¢ Control de costos<br>
                            ‚Ä¢ Escalamiento adaptativo<br>
                            ‚Ä¢ Performance optimization
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3>8.2. Evitar Loops Infinitos</h3>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Peligro: Loops Infinitos</strong>
                <p>Los workflows condicionales con retry logic pueden crear loops infinitos. Prevenci√≥n:</p>
                <ul>
                    <li>‚úÖ <strong>L√≠mite de intentos:</strong> <code>if attempt < MAX_ATTEMPTS</code></li>
                    <li>‚úÖ <strong>Timeout global:</strong> Limitar tiempo total de ejecuci√≥n</li>
                    <li>‚úÖ <strong>Condici√≥n de salida:</strong> Siempre tener una ruta que termina</li>
                    <li>‚úÖ <strong>Tracking de estado:</strong> Contar iteraciones en el data</li>
                </ul>
            </div>

            <h3>8.3. Testing de Workflows Condicionales</h3>

            <div class="success-box">
                <strong>‚úÖ Estrategia de Testing:</strong>
                <ol>
                    <li><strong>Test todas las rutas:</strong> Cada if/elif/else debe tener un test</li>
                    <li><strong>Test edge cases:</strong> L√≠mites de retry, timeouts, valores extremos</li>
                    <li><strong>Mock del agente:</strong> Controlar las decisiones para testing determin√≠stico</li>
                    <li><strong>Integration tests:</strong> Ejecutar workflow completo con casos reales</li>
                </ol>
            </div>

            <!-- Resumen Final -->
            <h2>üéØ Resumen Final</h2>

            <div class="success-box">
                <h3 style="margin-top: 0;">Conceptos Clave Aprendidos:</h3>
                <ol>
                    <li><strong>Workflows Condicionales</strong> permiten routing din√°mico basado en condiciones</li>
                    <li><strong>3 patrones:</strong> Clasificador (if/else), Validador (retry loop), Complejidad (scoring)</li>
                    <li><strong>send_message_to(id, data)</strong> es la clave para routing din√°mico</li>
                    <li><strong>Agentes toman decisiones</strong> de routing analizando contenido</li>
                    <li><strong>Retry logic</strong> permite auto-correcci√≥n con l√≠mites de seguridad</li>
                    <li><strong>Optimizaci√≥n de recursos</strong> con routing por complejidad</li>
                    <li><strong>Prevenci√≥n de loops</strong> con contadores de intentos</li>
                </ol>
            </div>

            <div class="info-box">
                <h3 style="margin-top: 0;">Pr√≥ximos Pasos Sugeridos:</h3>
                <ul>
                    <li>üîÄ Combinar con <strong>workflows paralelos</strong> (fan-out condicional)</li>
                    <li>üë• Implementar <strong>Group Chat</strong> con selecci√≥n din√°mica de speakers</li>
                    <li>üéØ Crear <strong>Supervisor Pattern</strong> que decide qu√© workers usar</li>
                    <li>üìä Agregar <strong>m√©tricas</strong> para analizar qu√© rutas se usan m√°s</li>
                    <li>üîÑ Implementar <strong>fallbacks</strong> autom√°ticos en caso de error</li>
                    <li>üé® Crear <strong>A/B testing</strong> con routing aleatorio</li>
                </ul>
            </div>

            <!-- Tabla de Referencia -->
            <h2>üìö Referencia R√°pida</h2>
            <table>
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>C√≥digo</th>
                        <th>Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Routing condicional</strong></td>
                        <td><code>await ctx.send_message_to("ExecutorID", data)</code></td>
                        <td>Enviar a executor espec√≠fico</td>
                    </tr>
                    <tr>
                        <td><strong>Terminar workflow</strong></td>
                        <td><code>await ctx.yield_output(result)</code></td>
                        <td>Producir output final</td>
                    </tr>
                    <tr>
                        <td><strong>L√≠mite de retry</strong></td>
                        <td><code>if attempt < MAX_ATTEMPTS:</code></td>
                        <td>Prevenir loops infinitos</td>
                    </tr>
                    <tr>
                        <td><strong>Agregar rutas</strong></td>
                        <td><code>.add_edge(source, target)</code></td>
                        <td>Definir topolog√≠a</td>
                    </tr>
                    <tr>
                        <td><strong>Pasar estado</strong></td>
                        <td><code>{"data": x, "attempt": n}</code></td>
                        <td>Dict con metadata</td>
                    </tr>
                </tbody>
            </table>

            <div class="warning-box" style="margin-top: 30px;">
                <strong>‚ö†Ô∏è Recordatorio Final:</strong>
                <p style="font-size: 1.1em;">
                    Los workflows condicionales son poderosos pero aumentan la complejidad. √ösalos cuando realmente
                    necesites comportamiento adaptativo. Para flujos simples, secuenciales o paralelos son m√°s f√°ciles
                    de entender y mantener.
                </p>
            </div>
        </div>

        <div class="footer">
            <h3>üîÄ Documentaci√≥n de Workflows Condicionales</h3>
            <p>Script: <strong>019_conditional_workflows.py</strong></p>
            <p>Microsoft Agent Framework + Azure AI Foundry</p>
            <p>3 Patrones | If/Else | Retry Logic | Dynamic Routing</p>
            <p style="margin-top: 15px; opacity: 0.8;">
                Generado autom√°ticamente | ¬© 2025
            </p>
        </div>
    </div>
</body>
</html>
