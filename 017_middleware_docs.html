<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentaci√≥n: Middleware - Microsoft Agent Framework</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        h2 {
            color: #fa709a;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 2em;
            border-bottom: 3px solid #fa709a;
            padding-bottom: 10px;
        }

        h3 {
            color: #ff6b9d;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        h4 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .diagram-container {
            background: #fff5f8;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #fa709a;
        }

        .diagram-title {
            text-align: center;
            font-weight: bold;
            color: #fa709a;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .flow-box {
            background: white;
            border: 3px solid #fa709a;
            border-radius: 8px;
            padding: 20px 30px;
            min-width: 180px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .flow-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .flow-box.middleware {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            font-weight: bold;
        }

        .flow-box.agent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .arrow-down {
            font-size: 2em;
            color: #fa709a;
            font-weight: bold;
            display: block;
            text-align: center;
            margin: 10px 0;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border-left: 4px solid #fa709a;
        }

        .code-block code {
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.5;
            white-space: pre-wrap;
            display: block;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #856404;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .component-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .component-card:hover {
            border-color: #fa709a;
            box-shadow: 0 4px 16px rgba(250, 112, 154, 0.3);
        }

        .component-card h4 {
            color: #fa709a;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #fa709a;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #fff5f8;
        }

        .toc {
            background: #fff5f8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .toc h3 {
            color: #fa709a;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            margin-left: 0;
        }

        .toc li {
            margin-bottom: 10px;
        }

        .toc a {
            color: #fa709a;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .toc a:hover {
            color: #ff6b9d;
            text-decoration: underline;
        }

        .footer {
            background: #2d2d2d;
            color: white;
            padding: 30px;
            text-align: center;
        }

        ul, ol {
            margin-left: 30px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
        }

        .middleware-chain {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîó Middleware - Microsoft Agent Framework</h1>
            <p>Documentaci√≥n Completa del Script 017_middleware.py</p>
        </header>

        <div class="content">
            <!-- Tabla de Contenidos -->
            <div class="toc">
                <h3>üìë Tabla de Contenidos</h3>
                <ul>
                    <li><a href="#introduccion">1. Introducci√≥n</a></li>
                    <li><a href="#conceptos">2. ¬øQu√© es el Middleware?</a></li>
                    <li><a href="#tipos">3. Tres Tipos de Middleware</a></li>
                    <li><a href="#implementaciones">4. 8 Middlewares Implementados</a></li>
                    <li><a href="#cadena">5. Cadena de Middlewares (Pipeline)</a></li>
                    <li><a href="#casos-uso">6. Casos de Uso Comunes</a></li>
                    <li><a href="#mejores-practicas">7. Mejores Pr√°cticas</a></li>
                </ul>
            </div>

            <!-- 1. Introducci√≥n -->
            <h2 id="introduccion">1. üìñ Introducci√≥n</h2>
            <p>
                El script <span class="highlight">017_middleware.py</span> demuestra c√≥mo usar
                <strong>Middleware</strong> en el <strong>Microsoft Agent Framework</strong>.
                El Middleware permite <strong>interceptar y modificar el comportamiento</strong> de agentes,
                funciones y chats sin modificar su c√≥digo principal.
            </p>

            <div class="success-box">
                <strong>üéØ Concepto Clave:</strong> El Middleware es un patr√≥n de dise√±o que permite agregar
                funcionalidad <strong>cross-cutting</strong> (transversal) sin modificar el c√≥digo original.
                Piensa en ello como "capas" que envuelven la funcionalidad principal.
            </div>

            <div class="info-box">
                <strong>üí° Analog√≠a del Mundo Real:</strong>
                <p>Imagina que vas a un restaurante:</p>
                <ul>
                    <li>üö™ <strong>Recepci√≥n</strong>: Verifican tu reserva (autenticaci√≥n)</li>
                    <li>üìã <strong>Tomar orden</strong>: Validan el men√∫ (validaci√≥n)</li>
                    <li>üë®‚Äçüç≥ <strong>Cocina</strong>: Preparan la comida (funci√≥n principal)</li>
                    <li>üìä <strong>Sistema</strong>: Registran la venta (logging)</li>
                    <li>‚è±Ô∏è <strong>Gerente</strong>: Miden tiempo de servicio (timing)</li>
                </ul>
                <p>
                    Cada paso es un "middleware" que agrega funcionalidad sin cambiar la cocina misma.
                </p>
            </div>

            <!-- Diagrama Principal -->
            <div class="diagram-container">
                <div class="diagram-title">üîÑ Flujo de Middleware (Request ‚Üí Response)</div>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <div class="flow-box">
                        <strong>üì• Request</strong><br>
                        <small>Usuario llama a agent.run()</small>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div style="background: #fff5f8; padding: 20px; border-radius: 8px; border: 2px dashed #fa709a; width: 80%;">
                        <strong style="color: #fa709a; display: block; text-align: center; margin-bottom: 15px;">
                            MIDDLEWARE CHAIN (Pre-procesamiento)
                        </strong>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #2196F3;">
                                ‚ûä Middleware 1: Autenticaci√≥n
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                                ‚ûã Middleware 2: Rate Limiting
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745;">
                                ‚ûå Middleware 3: Logging
                            </div>
                        </div>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div class="flow-box agent">
                        <strong>ü§ñ AGENTE</strong><br>
                        <small>Funci√≥n principal ejecuta</small>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div style="background: #fff5f8; padding: 20px; border-radius: 8px; border: 2px dashed #fa709a; width: 80%;">
                        <strong style="color: #fa709a; display: block; text-align: center; margin-bottom: 15px;">
                            MIDDLEWARE CHAIN (Post-procesamiento)
                        </strong>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745;">
                                ‚ûå Middleware 3: M√©tricas
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                                ‚ûã Middleware 2: Analytics
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #2196F3;">
                                ‚ûä Middleware 1: Cleanup
                            </div>
                        </div>
                    </div>

                    <span class="arrow-down">‚Üì</span>

                    <div class="flow-box">
                        <strong>üì§ Response</strong><br>
                        <small>Usuario recibe resultado</small>
                    </div>
                </div>
            </div>

            <!-- 2. Conceptos -->
            <h2 id="conceptos">2. üß† ¬øQu√© es el Middleware?</h2>

            <p>
                El Middleware es c√≥digo que se ejecuta <strong>antes y despu√©s</strong> de una funci√≥n principal,
                permitiendo agregar funcionalidad sin modificar la funci√≥n misma.
            </p>

            <div class="component-grid">
                <div class="component-card">
                    <h4>üéØ Prop√≥sito</h4>
                    <p>Agregar funcionalidad cross-cutting (transversal) como:</p>
                    <ul>
                        <li>Logging</li>
                        <li>Autenticaci√≥n</li>
                        <li>Validaci√≥n</li>
                        <li>M√©tricas</li>
                        <li>Caching</li>
                        <li>Retry logic</li>
                    </ul>
                </div>

                <div class="component-card">
                    <h4>‚úÖ Ventajas</h4>
                    <ul>
                        <li><strong>Separaci√≥n de concerns</strong></li>
                        <li><strong>C√≥digo reutilizable</strong></li>
                        <li><strong>No modifica c√≥digo original</strong></li>
                        <li><strong>F√°cil de activar/desactivar</strong></li>
                        <li><strong>Composable</strong> (cadenas)</li>
                        <li><strong>Testeable</strong> independientemente</li>
                    </ul>
                </div>

                <div class="component-card">
                    <h4>üìã Estructura</h4>
                    <div class="code-block" style="margin-top: 10px;"><code>@middleware_decorator
async def my_middleware(context, next):
    # PRE: Antes de ejecutar
    print("Antes")

    # Ejecutar funci√≥n principal
    await next(context)

    # POST: Despu√©s de ejecutar
    print("Despu√©s")</code></div>
                </div>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Regla Fundamental:</strong> Siempre debes llamar <span class="highlight">await next(context)</span>
                en tu middleware, de lo contrario interrumpir√°s la cadena de ejecuci√≥n y la funci√≥n principal nunca se ejecutar√°.
            </div>

            <!-- 3. Tipos de Middleware -->
            <h2 id="tipos">3. üîó Tres Tipos de Middleware</h2>

            <p>
                El Microsoft Agent Framework proporciona <strong>3 tipos diferentes de middleware</strong>,
                cada uno intercepta un nivel diferente de la ejecuci√≥n:
            </p>

            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Decorador</th>
                        <th>Intercepta</th>
                        <th>Context Type</th>
                        <th>Uso T√≠pico</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Agent Middleware</strong></td>
                        <td><code>@agent_middleware</code></td>
                        <td>Runs completos del agente</td>
                        <td><code>AgentRunContext</code></td>
                        <td>Logging, timing, auth</td>
                    </tr>
                    <tr>
                        <td><strong>Function Middleware</strong></td>
                        <td><code>@function_middleware</code></td>
                        <td>Llamadas a tools/funciones</td>
                        <td><code>FunctionInvocationContext</code></td>
                        <td>Validaci√≥n, cache</td>
                    </tr>
                    <tr>
                        <td><strong>Chat Middleware</strong></td>
                        <td><code>@chat_middleware</code></td>
                        <td>Mensajes de chat</td>
                        <td><code>ChatContext</code></td>
                        <td>Filtrado de contenido</td>
                    </tr>
                </tbody>
            </table>

            <h3>3.1. Agent Middleware - Intercepta Runs Completos</h3>

            <div class="code-block"><code>from agent_framework import agent_middleware, AgentRunContext

@agent_middleware
async def logging_middleware(context: AgentRunContext, next):
    &quot;&quot;&quot;
    Intercepta TODA la ejecuci√≥n del agente.

    AgentRunContext contiene:
    - agent: El agente que se est√° ejecutando
    - messages: Mensajes de entrada
    - result: Resultado (despu√©s de next())
    &quot;&quot;&quot;
    print(f&quot;[LOG] üì• Iniciando run del agente '{context.agent.name}'&quot;)

    # Ejecutar el agente
    await next(context)

    # Despu√©s de la ejecuci√≥n
    print(f&quot;[LOG] üì§ Run completado: {context.result}&quot;)
</code></div>

            <h3>3.2. Function Middleware - Intercepta Llamadas a Tools</h3>

            <div class="code-block"><code>from agent_framework import function_middleware, FunctionInvocationContext

@function_middleware
async def logging_function_middleware(context: FunctionInvocationContext, next):
    &quot;&quot;&quot;
    Intercepta llamadas a funciones/tools del agente.

    FunctionInvocationContext contiene:
    - function: La funci√≥n que se est√° llamando
    - arguments: Los argumentos pasados
    - result: El resultado (despu√©s de next())
    &quot;&quot;&quot;
    print(f&quot;[FUNCTION] üîß Llamando: {context.function.name}&quot;)
    print(f&quot;[FUNCTION] üìã Args: {context.arguments}&quot;)

    # Ejecutar la funci√≥n
    await next(context)

    print(f&quot;[FUNCTION] ‚úÖ Resultado: {context.result}&quot;)
</code></div>

            <h3>3.3. Chat Middleware - Intercepta Mensajes</h3>

            <div class="code-block"><code>from agent_framework import chat_middleware, ChatContext

@chat_middleware
async def logging_chat_middleware(context: ChatContext, next):
    &quot;&quot;&quot;
    Intercepta mensajes de chat.

    ChatContext contiene:
    - messages: Los mensajes de la conversaci√≥n
    - result: La respuesta (despu√©s de next())
    &quot;&quot;&quot;
    print(f&quot;[CHAT] üí¨ Procesando {len(context.messages)} mensaje(s)&quot;)

    # Ejecutar el chat
    await next(context)

    print(f&quot;[CHAT] ü§ñ Respuesta: {context.result}&quot;)
</code></div>

            <!-- 4. Implementaciones -->
            <h2 id="implementaciones">4. üî© 8 Middlewares Implementados</h2>

            <p>El script demuestra <strong>8 middlewares diferentes</strong>, cubriendo los casos de uso m√°s comunes:</p>

            <div class="component-grid">
                <div class="component-card">
                    <h4>1Ô∏è‚É£ Logging Agent Middleware</h4>
                    <p><strong>Tipo:</strong> Agent</p>
                    <p><strong>Prop√≥sito:</strong> Loguear cada run del agente</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@agent_middleware
async def logging_agent_middleware(context, next):
    print(f&quot;Iniciando run de '{context.agent.name}'&quot;)
    await next(context)
    print(f&quot;Run completado&quot;)</code></div>
                </div>

                <div class="component-card">
                    <h4>2Ô∏è‚É£ Timing Middleware</h4>
                    <p><strong>Tipo:</strong> Agent</p>
                    <p><strong>Prop√≥sito:</strong> Medir tiempo de ejecuci√≥n</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@agent_middleware
async def timing_middleware(context, next):
    start = time.time()
    await next(context)
    elapsed = time.time() - start
    print(f&quot;Tiempo: {elapsed:.2f}s&quot;)</code></div>
                </div>

                <div class="component-card">
                    <h4>3Ô∏è‚É£ Content Filter Middleware</h4>
                    <p><strong>Tipo:</strong> Agent</p>
                    <p><strong>Prop√≥sito:</strong> Filtrar contenido sensible</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@agent_middleware
async def content_filter_middleware(context, next):
    await next(context)
    # Filtrar palabras sensibles
    if &quot;contrase√±a&quot; in str(context.result):
        print(&quot;‚ö†Ô∏è Contenido sensible detectado&quot;)</code></div>
                </div>

                <div class="component-card">
                    <h4>4Ô∏è‚É£ Logging Function Middleware</h4>
                    <p><strong>Tipo:</strong> Function</p>
                    <p><strong>Prop√≥sito:</strong> Loguear llamadas a tools</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@function_middleware
async def logging_function_middleware(context, next):
    print(f&quot;Llamando: {context.function.name}&quot;)
    await next(context)
    print(f&quot;Resultado: {context.result}&quot;)</code></div>
                </div>

                <div class="component-card">
                    <h4>5Ô∏è‚É£ Validation Middleware</h4>
                    <p><strong>Tipo:</strong> Function</p>
                    <p><strong>Prop√≥sito:</strong> Validar argumentos de funciones</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@function_middleware
async def validation_middleware(context, next):
    # Validar que n√∫meros no sean negativos
    if 'a' in context.arguments:
        if context.arguments['a'] &lt; 0:
            context.arguments['a'] = abs(...)
    await next(context)</code></div>
                </div>

                <div class="component-card">
                    <h4>6Ô∏è‚É£ Caching Middleware</h4>
                    <p><strong>Tipo:</strong> Function</p>
                    <p><strong>Prop√≥sito:</strong> Cachear resultados de funciones</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@function_middleware
async def caching_middleware(context, next):
    cache_key = f&quot;{context.function.name}:{context.arguments}&quot;
    if cache_key in cache:
        context.result = cache[cache_key]
        return  # No ejecutar funci√≥n
    await next(context)
    cache[cache_key] = context.result</code></div>
                </div>

                <div class="component-card">
                    <h4>7Ô∏è‚É£ Auth Middleware</h4>
                    <p><strong>Tipo:</strong> Agent</p>
                    <p><strong>Prop√≥sito:</strong> Verificar autenticaci√≥n</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@agent_middleware
async def auth_middleware(context, next):
    print(&quot;üîê Verificando autenticaci√≥n...&quot;)
    # Verificar tokens, permisos, etc.
    print(&quot;‚úÖ Usuario autenticado&quot;)
    await next(context)</code></div>
                </div>

                <div class="component-card">
                    <h4>8Ô∏è‚É£ Rate Limit Middleware</h4>
                    <p><strong>Tipo:</strong> Agent</p>
                    <p><strong>Prop√≥sito:</strong> Verificar l√≠mites de requests</p>
                    <div class="code-block" style="margin-top: 10px;"><code>@agent_middleware
async def rate_limit_middleware(context, next):
    print(&quot;üö¶ Verificando l√≠mite de requests...&quot;)
    # Verificar cuota, requests/min, etc.
    print(&quot;‚úÖ Dentro del l√≠mite&quot;)
    await next(context)</code></div>
                </div>
            </div>

            <!-- 5. Cadena de Middlewares -->
            <h2 id="cadena">5. üîó Cadena de Middlewares (Pipeline)</h2>

            <p>
                Una de las caracter√≠sticas m√°s poderosas es que puedes <strong>combinar m√∫ltiples middlewares</strong>
                que se ejecutan en orden, formando un "pipeline" de procesamiento.
            </p>

            <div class="middleware-chain">
                <h4 style="color: #fa709a; margin-bottom: 20px; text-align: center;">üìä Orden de Ejecuci√≥n</h4>
                <div style="background: #fff5f8; padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
                        <!-- Pre-procesamiento -->
                        <div>
                            <strong style="color: #fa709a;">‚¨áÔ∏è PRE-PROCESAMIENTO (Orden normal)</strong>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #2196F3;">
                                    ‚ûä Auth Middleware
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                                    ‚ûã Rate Limit Middleware
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745;">
                                    ‚ûå Logging Middleware
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #9c27b0;">
                                    ‚ûç Timing Middleware
                                </div>
                            </div>
                        </div>

                        <!-- Funci√≥n principal -->
                        <div style="text-align: center;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; font-weight: bold;">
                                ü§ñ<br>AGENTE<br>EJECUTA
                            </div>
                        </div>

                        <!-- Post-procesamiento -->
                        <div>
                            <strong style="color: #fa709a;">‚¨ÜÔ∏è POST-PROCESAMIENTO (Orden inverso)</strong>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #9c27b0;">
                                    ‚ûç Timing Middleware
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745;">
                                    ‚ûå Logging Middleware
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                                    ‚ûã Rate Limit Middleware
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #2196F3;">
                                    ‚ûä Auth Middleware
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="code-block"><code># Crear agente con M√öLTIPLES middlewares
agent = client.create_agent(
    name=&quot;Secure Agent&quot;,
    instructions=&quot;Eres un asistente seguro&quot;,
    middleware=[
        auth_middleware,        # 1Ô∏è‚É£ Primero: Autenticaci√≥n
        rate_limit_middleware,  # 2Ô∏è‚É£ Segundo: Rate limiting
        audit_middleware,       # 3Ô∏è‚É£ Tercero: Auditor√≠a
        logging_middleware,     # 4Ô∏è‚É£ Cuarto: Logging
        timing_middleware       # 5Ô∏è‚É£ Quinto: Timing
    ]  # ‚Üê Se ejecutan en ORDEN
)

# Cuando llamas agent.run():
# PRE: Auth ‚Üí Rate Limit ‚Üí Audit ‚Üí Logging ‚Üí Timing ‚Üí ü§ñ AGENTE
# POST: Timing ‚Üí Logging ‚Üí Audit ‚Üí Rate Limit ‚Üí Auth
</code></div>

            <div class="info-box">
                <strong>üí° Orden de Ejecuci√≥n:</strong>
                <ul>
                    <li><strong>PRE-procesamiento:</strong> Se ejecutan en el orden especificado (1‚Üí2‚Üí3‚Üí4‚Üí5)</li>
                    <li><strong>POST-procesamiento:</strong> Se ejecutan en orden inverso (5‚Üí4‚Üí3‚Üí2‚Üí1)</li>
                    <li>Esto crea un patr√≥n "cebolla" o "matryoshka" (mu√±eca rusa)</li>
                </ul>
            </div>

            <!-- 6. Casos de Uso -->
            <h2 id="casos-uso">6. üéØ Casos de Uso Comunes</h2>

            <table>
                <thead>
                    <tr>
                        <th>Caso de Uso</th>
                        <th>Tipo de Middleware</th>
                        <th>Implementaci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Logging y Auditor√≠a</strong></td>
                        <td>Agent / Function / Chat</td>
                        <td>Registrar todas las interacciones en logs/DB</td>
                    </tr>
                    <tr>
                        <td><strong>Performance Monitoring</strong></td>
                        <td>Agent / Function</td>
                        <td>Medir tiempo, memoria, CPU</td>
                    </tr>
                    <tr>
                        <td><strong>Autenticaci√≥n</strong></td>
                        <td>Agent</td>
                        <td>Verificar tokens JWT, API keys, permisos</td>
                    </tr>
                    <tr>
                        <td><strong>Rate Limiting</strong></td>
                        <td>Agent</td>
                        <td>Limitar requests por usuario/IP/tiempo</td>
                    </tr>
                    <tr>
                        <td><strong>Validaci√≥n de Inputs</strong></td>
                        <td>Function</td>
                        <td>Sanitizar, validar tipos, rangos</td>
                    </tr>
                    <tr>
                        <td><strong>Caching</strong></td>
                        <td>Function</td>
                        <td>Cache resultados con Redis/memoria</td>
                    </tr>
                    <tr>
                        <td><strong>Content Filtering</strong></td>
                        <td>Agent / Chat</td>
                        <td>Filtrar contenido inapropiado/sensible</td>
                    </tr>
                    <tr>
                        <td><strong>Retry Logic</strong></td>
                        <td>Function</td>
                        <td>Reintentar en caso de errores transitorios</td>
                    </tr>
                    <tr>
                        <td><strong>Error Handling</strong></td>
                        <td>Agent / Function</td>
                        <td>Capturar excepciones, fallbacks</td>
                    </tr>
                    <tr>
                        <td><strong>M√©tricas</strong></td>
                        <td>Agent / Function</td>
                        <td>Enviar a Prometheus, DataDog, etc.</td>
                    </tr>
                </tbody>
            </table>

            <!-- 7. Mejores Pr√°cticas -->
            <h2 id="mejores-practicas">7. ‚ú® Mejores Pr√°cticas</h2>

            <h3>7.1. Dise√±o de Middlewares</h3>

            <div class="success-box">
                <strong>‚úÖ DO's (Hazlo):</strong>
                <ul>
                    <li>‚úÖ <strong>Siempre llama await next(context)</strong> - De lo contrario la cadena se rompe</li>
                    <li>‚úÖ <strong>Mant√©n middlewares peque√±os</strong> - Un prop√≥sito espec√≠fico por middleware</li>
                    <li>‚úÖ <strong>Hazlos reutilizables</strong> - No acoplados a agentes espec√≠ficos</li>
                    <li>‚úÖ <strong>Documenta claramente</strong> - Qu√© hace, cu√°ndo usarlo</li>
                    <li>‚úÖ <strong>Maneja errores apropiadamente</strong> - Try/except cuando sea necesario</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>‚ùå DON'Ts (No lo hagas):</strong>
                <ul>
                    <li>‚ùå <strong>No olvides await next(context)</strong> - Romper√° la ejecuci√≥n</li>
                    <li>‚ùå <strong>No hagas operaciones bloqueantes</strong> - Usa async/await</li>
                    <li>‚ùå <strong>No modifiques context destructivamente</strong> - Sin buena raz√≥n</li>
                    <li>‚ùå <strong>No agregues demasiados middlewares</strong> - Impacto en performance</li>
                    <li>‚ùå <strong>No asumas orden de ejecuci√≥n</strong> - Depende del orden en la lista</li>
                </ul>
            </div>

            <h3>7.2. Orden de Middlewares</h3>

            <div class="info-box">
                <strong>üí° Orden Recomendado (General):</strong>
                <ol>
                    <li><strong>1Ô∏è‚É£ Auth/Security</strong> - Primero para fallar r√°pido si no autorizado</li>
                    <li><strong>2Ô∏è‚É£ Rate Limiting</strong> - Antes de consumir recursos</li>
                    <li><strong>3Ô∏è‚É£ Logging/Auditor√≠a</strong> - Registrar la petici√≥n entrante</li>
                    <li><strong>4Ô∏è‚É£ Validaci√≥n</strong> - Validar inputs antes de procesar</li>
                    <li><strong>5Ô∏è‚É£ Caching</strong> - Evitar trabajo innecesario</li>
                    <li><strong>6Ô∏è‚É£ Timing/M√©tricas</strong> - Medir la ejecuci√≥n real</li>
                </ol>
            </div>

            <h3>7.3. Testing de Middlewares</h3>

            <div class="code-block"><code># Ejemplo de test para middleware
import pytest

@pytest.mark.asyncio
async def test_logging_middleware():
    # Arrange
    called = False
    logged_before = False
    logged_after = False

    class MockContext:
        agent = type('obj', (object,), {'name': 'TestAgent'})()
        result = &quot;Test Result&quot;

    async def mock_next(context):
        nonlocal called
        called = True

    # Act
    await logging_middleware(MockContext(), mock_next)

    # Assert
    assert called == True
    # Verificar que se hizo logging
</code></div>

            <!-- Resumen Final -->
            <h2>üéØ Resumen Final</h2>

            <div class="success-box">
                <h3 style="margin-top: 0;">Conceptos Clave Aprendidos:</h3>
                <ol>
                    <li><strong>Middleware</strong> intercepta ejecuci√≥n sin modificar c√≥digo original</li>
                    <li><strong>3 tipos</strong>: Agent (runs), Function (tools), Chat (mensajes)</li>
                    <li><strong>8 implementaciones</strong>: Logging, Timing, Content Filter, Validation, Caching, Auth, Rate Limit, Audit</li>
                    <li><strong>Cadena de middlewares</strong>: PRE en orden, POST en orden inverso</li>
                    <li><strong>await next(context)</strong> es OBLIGATORIO para continuar la cadena</li>
                    <li><strong>Cross-cutting concerns</strong>: Funcionalidad transversal sin modificar l√≥gica</li>
                    <li><strong>Composable</strong>: M√∫ltiples middlewares combinados</li>
                </ol>
            </div>

            <div class="info-box">
                <h3 style="margin-top: 0;">Pr√≥ximos Pasos Sugeridos:</h3>
                <ul>
                    <li>üìä Implementar <strong>Observabilidad y Telemetr√≠a</strong> completa</li>
                    <li>üîÑ Combinar con <strong>Context Providers</strong> para m√°xima flexibilidad</li>
                    <li>üõ°Ô∏è Crear <strong>Security Middleware Stack</strong> (Auth + Rate Limit + Content Filter)</li>
                    <li>üíæ Implementar <strong>Distributed Caching</strong> con Redis</li>
                    <li>üîÅ Agregar <strong>Retry Logic</strong> robusto con exponential backoff</li>
                    <li>üìà Integrar con <strong>APM</strong> (Application Performance Monitoring)</li>
                </ul>
            </div>

            <!-- Tabla de Referencia -->
            <h2>üìö Referencia R√°pida</h2>
            <table>
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>C√≥digo</th>
                        <th>Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Agent Middleware</strong></td>
                        <td><code>@agent_middleware</code></td>
                        <td>Intercepta runs completos</td>
                    </tr>
                    <tr>
                        <td><strong>Function Middleware</strong></td>
                        <td><code>@function_middleware</code></td>
                        <td>Intercepta llamadas a tools</td>
                    </tr>
                    <tr>
                        <td><strong>Chat Middleware</strong></td>
                        <td><code>@chat_middleware</code></td>
                        <td>Intercepta mensajes</td>
                    </tr>
                    <tr>
                        <td><strong>Ejecutar siguiente</strong></td>
                        <td><code>await next(context)</code></td>
                        <td>OBLIGATORIO para continuar</td>
                    </tr>
                    <tr>
                        <td><strong>Acceder a agente</strong></td>
                        <td><code>context.agent</code></td>
                        <td>En AgentRunContext</td>
                    </tr>
                    <tr>
                        <td><strong>Acceder a funci√≥n</strong></td>
                        <td><code>context.function</code></td>
                        <td>En FunctionInvocationContext</td>
                    </tr>
                    <tr>
                        <td><strong>Acceder a resultado</strong></td>
                        <td><code>context.result</code></td>
                        <td>Despu√©s de await next()</td>
                    </tr>
                    <tr>
                        <td><strong>Usar m√∫ltiples</strong></td>
                        <td><code>middleware=[m1, m2, m3]</code></td>
                        <td>En create_agent()</td>
                    </tr>
                </tbody>
            </table>

            <div class="warning-box" style="margin-top: 30px;">
                <strong>‚ö†Ô∏è Regla de Oro del Middleware:</strong>
                <p style="font-size: 1.2em; font-weight: bold; color: #fa709a;">
                    SIEMPRE llama <code>await next(context)</code> en tu middleware, a menos que
                    expl√≠citamente quieras interrumpir la ejecuci√≥n (ej: autenticaci√≥n fallida).
                </p>
            </div>
        </div>

        <div class="footer">
            <h3>üîó Documentaci√≥n de Middleware</h3>
            <p>Script: <strong>017_middleware.py</strong></p>
            <p>Microsoft Agent Framework + Azure AI Foundry</p>
            <p>3 Tipos | 8 Middlewares | Cross-Cutting Concerns</p>
            <p style="margin-top: 15px; opacity: 0.8;">
                Generado autom√°ticamente | ¬© 2025
            </p>
        </div>
    </div>
</body>
</html>
